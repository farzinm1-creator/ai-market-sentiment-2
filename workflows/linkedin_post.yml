name: LinkedIn Daily Post

on:
  schedule:
    - cron: '0 10 * * *'      # Ø±ÙˆØ²Ø§Ù†Ù‡ 10:00 UTC (~13:30 Ø§ÛŒØ±Ø§Ù†)
  workflow_dispatch:          # Ø§Ø¬Ø±Ø§ÛŒ Ø¯Ø³ØªÛŒ

jobs:
  post-linkedin:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build message (from DATA_URL or file)
        id: build
        env:
          DATA_URL: ${{ secrets.DATA_URL }}
        run: |
          set -e
          echo "[Build] Building post payloadâ€¦"

          if [ -n "$DATA_URL" ]; then
            python - <<'PY'
import json, urllib.request, datetime
url = "${{ secrets.DATA_URL }}"
with urllib.request.urlopen(url, timeout=20) as r:
    data = json.load(r)
if not data:
    txt="Daily Sentiment Snapshot:\nNo data received."
else:
    for x in data:
        x["__dt"]=datetime.datetime.fromisoformat(x["day"])
    latest=max(x["__dt"] for x in data)
    rows=[x for x in data if x["__dt"].date()==latest.date()]
    lines=[f"ğŸ“Š Daily Market Sentiment Snapshot ({latest.date()}):"]
    for x in sorted(rows,key=lambda z:z["asset"]):
        s=float(x["avg_sentiment"])
        emo = "âœ… bullish" if s>0.15 else ("â— bearish" if s<-0.15 else "â¸ï¸ neutral")
        lines.append(f"- {x['asset']}: {s:.2f} â†’ {emo}")
    lines+=["", "ğŸ”— Demo: https://sentiment-demo.onrender.com",
            "ğŸš€ Pro: https://sentiment-pro.onrender.com", "",
            "#Crypto #Gold #Oil #Forex #AI #Trading", "",
            "â± " + datetime.datetime.utcnow().strftime("%Y-%m-%d %H:%M UTC")]
    txt="\n".join(lines)

open("payload.json","w",encoding="utf-8").write(
    json.dumps({"text":txt}, ensure_ascii=False)
)
print(txt[:300])
PY
          else
            python - <<'PY'
import json, datetime
with open("data/daily_sentiment.json","r",encoding="utf-8") as f:
    data=json.load(f)
if not data:
    txt="Daily Sentiment Snapshot:\nNo data received."
else:
    for x in data:
        x["__dt"]=datetime.datetime.fromisoformat(x["day"])
    latest=max(x["__dt"] for x in data)
    rows=[x for x in data if x["__dt"].date()==latest.date()]
    lines=[f"ğŸ“Š Daily Market Sentiment Snapshot ({latest.date()}):"]
    for x in sorted(rows,key=lambda z:z["asset"]):
        s=float(x["avg_sentiment"])
        emo = "âœ… bullish" if s>0.15 else ("â— bearish" if s<-0.15 else "â¸ï¸ neutral")
        lines.append(f"- {x['asset']}: {s:.2f} â†’ {emo}")
    lines+=["", "ğŸ”— Demo: https://sentiment-demo.onrender.com",
            "ğŸš€ Pro: https://sentiment-pro.onrender.com", "",
            "#Crypto #Gold #Oil #Forex #AI #Trading", "",
            "â± " + datetime.datetime.utcnow().strftime("%Y-%m-%d %H:%M UTC")]
    txt="\n".join(lines)

open("payload.json","w",encoding="utf-8").write(
    json.dumps({"text":txt}, ensure_ascii=False)
)
print(txt[:300])
PY
          fi

      - name: Send to Zapier (curl)
        env:
          ZAPIER_HOOK_URL: ${{ secrets.ZAPIER_HOOK_URL }}
        run: |
          set -e
          test -n "$ZAPIER_HOOK_URL" || (echo "ZAPIER_HOOK_URL is empty" && exit 1)
          echo "[Send] POST to: $ZAPIER_HOOK_URL"
          http_code=$(curl -sS -o resp.txt -w "%{http_code}" \
            -X POST "$ZAPIER_HOOK_URL" \
            -H "Content-Type: application/json" \
            --data-binary @payload.json)
          echo "HTTP code: $http_code"
          echo "--- Response ---"
          cat resp.txt
          echo "----------------"
          [ "$http_code" -ge 200 ] && [ "$http_code" -lt 300 ]
