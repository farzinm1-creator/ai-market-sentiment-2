name: LinkedIn Daily Post

on:
  schedule:
    - cron: '0 10 * * *'      # Ø±ÙˆØ²Ø§Ù†Ù‡ 10:00 UTC (Ø­Ø¯ÙˆØ¯ 13:30 Ø§ÛŒØ±Ø§Ù†)
  workflow_dispatch:          # Ø§Ø¬Ø±Ø§ÛŒ Ø¯Ø³ØªÛŒ

jobs:
  post-linkedin:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Build post text
        id: build
        run: |
          python - << 'PY'
          import json
          from datetime import datetime

          with open("data/daily_sentiment.json","r",encoding="utf-8") as f:
              data=json.load(f)

          if not data:
              txt="Daily Sentiment Snapshot:\nNo data received."
          else:
              for r in data:
                  r["__dt"]=datetime.fromisoformat(r["day"])
              latest=max(r["__dt"] for r in data)
              rows=[r for r in data if r["__dt"].date()==latest.date()]

              lines=[f"ğŸ“Š Daily Market Sentiment Snapshot ({latest.date()}):"]
              for r in sorted(rows,key=lambda x:x["asset"]):
                  s=float(r["avg_sentiment"])
                  emo="âœ… bullish" if s>0.15 else ("â— bearish" if s<-0.15 else "â¸ï¸ neutral")
                  lines.append(f"- {r['asset']}: {s:.2f} â†’ {emo}")
              lines.append("\nğŸ”— Demo (BTC only): https://sentiment-demo.onrender.com")
              lines.append("ğŸš€ Pro (all assets + alerts): https://sentiment-pro.onrender.com")
              lines.append("\n#Crypto #Gold #Oil #Forex #AI #Sentiment #Trading")
              lines.append("\nâ± " + datetime.utcnow().strftime("%Y-%m-%d %H:%M UTC"))
              txt="\n".join(lines)

          print(txt)  # Ù…ØªÙ† Ù¾Ø³Øª Ø¯Ø± Ù„Ø§Ú¯
          with open("post.txt","w",encoding="utf-8") as f:
              f.write(txt)
          PY

      - name: Send to Zapier webhook
        env:
          ZAPIER_HOOK_URL: ${{ secrets.ZAPIER_HOOK_URL }}
        run: |
          python - << 'PY'
          import os, requests, sys
          url=os.environ.get("ZAPIER_HOOK_URL","").strip()
          if not url:
              print("ERROR: ZAPIER_HOOK_URL is empty.", file=sys.stderr)
              sys.exit(1)
          with open("post.txt","r",encoding="utf-8") as f:
              text=f.read()
          r=requests.post(url, json={"text": text}, timeout=15)
          print("Webhook status:", r.status_code)
          print("Posted to webhook.")
          r.raise_for_status()
          PY
